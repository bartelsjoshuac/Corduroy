<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Approval Admin</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'corduroyserver/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js" defer></script>
</head>
<body>
    <div class="container" x-data="approvalAdmin()" x-init="initializeReports()">
        <h1>Pending Reports Admin</h1>
        
        <h2>Change Approval Status and View Report Text</h2>
        <form method="post" @submit.prevent="updateApproval">
            {% csrf_token %}
            <table>
                <tr>
                    <td><label for="report_id">Select Report:</label></td>
                    <td>
                        <select id="report_id" name="report_id" x-model="selectedReportId" @change="updateReportText()">
                            <option value="">Select a Report</option>
                            <template x-for="report in reports" :key="report.id">
                                <option :value="report.id" x-text="`${report.trail.trailName} - ${report.date} - ${report.approvalStatus ? 'Approved' : 'Not Approved'}`"></option>
                            </template>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Approval Status:</td>
                    <td>
                        <input type="checkbox" id="approvalStatus" x-model="approvalStatus"> (unchecked to un-approve)
                    </td>
                </tr>
                <tr>
                    <td><label for="report_text">Report Text (read only):</label></td>
                    <td>
                        <textarea id="report_text" rows="4" cols="50" readonly x-text="reportText"></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <button type="submit">Update Approval Status</button>
                    </td>
                </tr>
            </table>
        </form>
        
        <p><a href="{% url 'homepage' %}">Back to Home</a></p>
    </div>

    <script>
        function approvalAdmin() {
            return {
                reports: [], // List of reports fetched from the backend
                selectedReportId: '', // Currently selected report ID
                approvalStatus: false, // Approval status for the selected report
                reportText: '', // Text of the selected report

                initializeReports() {
                    // Fetch the reports data from the backend
                    fetch('/api/reports/')
                        .then(response => response.json())
                        .then(data => {
                            this.reports = data.filter(report => !report.approvalStatus); // Only show pending reports
                            if (this.reports.length > 0) {
                                this.selectedReportId = this.reports[0].id; // Auto-select the first report
                                this.updateReportText();
                            }
                        });
                },

                updateReportText() {
                    // Update the report text and approval status based on the selected report
                    const selectedReport = this.reports.find(report => report.id === this.selectedReportId);
                    if (selectedReport) {
                        this.reportText = selectedReport.report;
                        this.approvalStatus = selectedReport.approvalStatus;
                    } else {
                        this.reportText = '';
                        this.approvalStatus = false;
                    }
                },

                updateApproval() {
                    // Send the updated approval status to the backend
                    fetch(`/api/reports/${this.selectedReportId}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}', // CSRF token for security
                        },
                        body: JSON.stringify({ approvalStatus: this.approvalStatus }),
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to update approval status');
                            return response.json();
                        })
                        .then(updatedReport => {
                            // Update the local reports list
                            const index = this.reports.findIndex(report => report.id === updatedReport.id);
                            if (index !== -1) {
                                this.reports.splice(index, 1, updatedReport);
                            }
                            alert('Approval status updated successfully.');
                        })
                        .catch(error => console.error(error));
                },
            };
        }
    </script>
</body>
</html>
