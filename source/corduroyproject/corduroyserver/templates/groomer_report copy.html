<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groomer Admin</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'corduroyserver/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js" defer></script>
    <style>
        .success-message {
            background-color: #ffffff; /* White background */
            color: #004085; /* Blue text */
            padding: 10px;
            border: 1px solid #28a745; /* Green border */
            border-radius: 5px;
            margin-bottom: 10px;
            display: none; /* Hidden by default */
        }
        .success-message.show {
            display: block; /* Visible when success */
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container" x-data="groomerForm()" x-init="initializeTrails()">
        <h1>Groomer Admin</h1>

        <!-- Success Message -->
        <div
            x-show="showSuccess"
            x-transition.opacity.duration.500ms
            class="success-message"
        >
            Report submitted successfully.
        </div>

        <form @submit.prevent="submitReport">
            {% csrf_token %}
            <table>
                <tr>
                    <td><label for="location">Location:</label></td>
                    <td>
                        <select id="location" x-model="selectedLocation" @change="updateTrails()" required>
                            <option value="">Select Location</option>
                            <template x-for="(trails, location) in trailsByLocation" :key="location">
                                <option :value="location" x-text="location"></option>
                            </template>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><label for="trail">Trail Name:</label></td>
                    <td>
                        <select id="trail" x-model="selectedTrail" required>
                            <option value="">Select Trail</option>
                            <template x-for="trail in filteredTrails" :key="trail.id">
                                <option :value="trail.id" x-text="trail.name"></option>
                            </template>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><label for="report">Report:</label></td>
                    <td>
                        <textarea id="report" x-model="reportText" rows="4" cols="50" required></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <button type="submit">Submit Report</button>
                    </td>
                </tr>
            </table>
        </form>

        <p><a href="{% url 'homepage' %}">Back to Home</a></p>
    </div>

    <script>
        function groomerForm() {
            return {
                trailsByLocation: {}, // Loaded from the backend
                selectedLocation: '', // Currently selected location
                selectedTrail: '', // Currently selected trail
                filteredTrails: [], // Trails for the selected location
                reportText: '', // Text entered for the report
                showSuccess: false, // Controls visibility of success message

                initializeTrails() {
                    console.log('Initializing trails...');
                    this.trailsByLocation = {
                        {% for location, trails in trails_by_location.items %}
                            "{{ location }}": [
                                {% for trail in trails %}
                                    { id: "{{ trail.id }}", name: "{{ trail.name }}" },
                                {% endfor %}
                            ],
                        {% endfor %}
                    };
                },

                updateTrails() {
                    this.filteredTrails = this.trailsByLocation[this.selectedLocation] || [];
                    this.selectedTrail = ''; // Reset the selected trail
                },

                submitReport() {
                    console.log('Submitting report...');
                    // Prepare the data for submission
                    const reportData = {
                        trail: this.selectedTrail,
                        report: this.reportText,
                    };

                    fetch('/api/reports/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify(reportData),
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to submit report');
                            return response.json();
                        })
                        .then(data => {
                            console.log('Report submitted successfully:', data);
                            this.selectedLocation = '';
                            this.filteredTrails = [];
                            this.selectedTrail = '';
                            this.reportText = '';

                            // Show success message
                            this.showSuccess = true;
                            setTimeout(() => {
                                this.showSuccess = false; // Hide after 3 seconds
                            }, 3000);
                        })
                        .catch(error => {
                            console.error('Error submitting report:', error);
                        });
                },
            };
        }
    </script>
</body>
</html>
