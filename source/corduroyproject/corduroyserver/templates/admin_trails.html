<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trails Admin</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'corduroyserver/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js" defer></script>
</head>
<body>
    <div class="container" x-data="trailAdmin()" x-init="initializeTrails()">
        <h1>Trails Admin</h1>

        <h2>Add a New Trail</h2>
        <form @submit.prevent="addTrail">
            {% csrf_token %}
            <table>
                <tr>
                    <td><label for="trailName">Trail Name:</label></td>
                    <td><input type="text" id="trailName" x-model="newTrail.trailName" required></td>
                </tr>
                <tr>
                    <td><label for="location">Location:</label></td>
                    <td>
                        <select id="location" x-model="newTrail.location" required>
                            <option value="" disabled>Select Location</option>
                            <template x-for="location in locations" :key="location">
                                <option x-text="location"></option>
                            </template>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><label for="rating">Rating:</label></td>
                    <td>
                        <input type="number" id="rating" x-model="newTrail.rating" min="1" max="10" required>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <button type="submit">Add Trail</button>
                    </td>
                </tr>
            </table>
        </form>

        <h2>Existing Trails</h2>
        <template x-if="trails.length > 0">
            <table>
                <thead>
                    <tr>
                        <th>Trail Name</th>
                        <th>Location</th>
                        <th>Rating</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="trail in trails" :key="trail.id">
                        <tr>
                            <td x-text="trail.trailName"></td>
                            <td x-text="trail.location"></td>
                            <td x-text="trail.rating"></td>
                            <td>
                                <form @submit.prevent="deleteTrail(trail.id)" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </template>
        <p x-show="trails.length === 0">No trails available.</p>

        <p><a href="{% url 'homepage' %}">Back to Home</a></p>
    </div>

    <script>
        function trailAdmin() {
            return {
                trails: [], // List of trails
                locations: ["Front Range", "Grand Mesa", "San Juans"], // Example locations
                newTrail: {
                    trailName: '',
                    location: '',
                    rating: '',
                },

                initializeTrails() {
                    // Fetch the initial list of trails from the backend
                    fetch('/api/trails/')
                        .then(response => response.json())
                        .then(data => {
                            this.trails = data;
                        });
                },

                addTrail() {
                    // Add a new trail via the backend
                    fetch('/api/trails/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}', // Add CSRF token for security
                        },
                        body: JSON.stringify(this.newTrail),
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to add trail');
                            return response.json();
                        })
                        .then(newTrail => {
                            this.trails.push(newTrail); // Add new trail to the local list
                            this.newTrail = { trailName: '', location: '', rating: '' }; // Reset the form
                        })
                        .catch(error => console.error(error));
                },

                deleteTrail(trailId) {
                    // Delete a trail via the backend
                    fetch(`/api/trails/${trailId}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}', // Add CSRF token for security
                        },
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to delete trail');
                            this.trails = this.trails.filter(trail => trail.id !== trailId); // Remove trail from local list
                        })
                        .catch(error => console.error(error));
                },
            };
        }
    </script>
</body>
</html>
